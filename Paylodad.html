<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#000000">
<title>Repositorio de Payloads (XSS / IDOR / RCE ‚Ä¶)</title>
<link rel="icon" href="fav_Aquiles.png" type="image/x-icon">
<style>
  :root{
    --bg:#000000; --card:#141c5b; --ink:#e7ffeb; --muted:#9aa3ff;
    --accent:#7c5cff; --accent-2:#e00000; --ok:#00e0c2; --warn:#ffd166;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
    background: var(--bg);
    color:var(--ink);
    display:grid; grid-template-columns:minmax(0,1fr); place-items:center; padding:24px;
  }
  .app{width:min(1200px, 100%); display:grid; grid-template-columns: 1fr 300px; gap:18px}
  @media (max-width:980px){ .app{grid-template-columns:1fr} .float{position:static} }

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
    border:1px solid rgba(255,255,255,0.08);
    border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.25); padding:20px;
    backdrop-filter: blur(6px);
  }
  h1{margin:0 0 8px; font-weight:800; letter-spacing:.3px}
  .sub{color:var(--muted); margin:0 0 18px; font-size:14px}

  .category{background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.015)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px; margin-bottom:14px}
  .chead{display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center}
  .ctitle{
    font-weight:900; letter-spacing:.4px; margin:0; font-size:18px;
    padding:6px 10px; border-radius:10px; border:1px dashed rgba(255,255,255,.18);
    background:linear-gradient(90deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
  }
  .ctitle[contenteditable="true"]{outline:2px solid rgba(124,92,255,.5)}
  .cactions{display:flex; gap:8px; flex-wrap:wrap; justify-self:end}
  .btn{
    appearance:none; border:none; border-radius:12px; padding:8px 12px; font-weight:700; letter-spacing:.2px;
    color:#0b0d1f; background:linear-gradient(90deg, var(--accent), var(--accent-2)); cursor:pointer;
    box-shadow:0 6px 18px rgba(124,92,255,.35); transition: transform .08s ease, filter .15s ease; font-size:13px;
  }
  .btn:hover{filter:brightness(1.06)}
  .btn:active{transform: translateY(1px)}
  .ghost{background:transparent; color:var(--ink); border:1px solid rgba(255,255,255,.18)}

  /* inputs & selects */
  .cfilters{display:flex; gap:8px; align-items:center; justify-self:stretch}
  .cfilter-input{
    width:100%; padding:8px 10px; border-radius:10px;
    background:rgba(255,255,255,.06); color:var(--ink);
    border:1px solid rgba(255,255,255,.14); font-weight:700; letter-spacing:.2px;
  }
  .cfilter-select{
    padding:8px 36px 8px 10px; border-radius:10px; min-width:170px;
    background:#0b0d1f; color:var(--ink);
    border:1px solid rgba(255,255,255,.18); font-weight:800; letter-spacing:.2px;
    appearance:none; -webkit-appearance:none; -moz-appearance:none;
    background-image:
      linear-gradient(45deg, rgba(255,255,255,.35) 50%, rgba(255,255,255,0) 50%),
      linear-gradient(135deg, rgba(255,255,255,.35) 50%, rgba(255,255,255,0) 50%);
    background-position: right 12px top 55%, right 6px top 55%;
    background-size: 8px 8px, 8px 8px; background-repeat:no-repeat;
  }
  .cfilter-select option{ background:#141826; color:#e6ecff; font-weight:700; }
  .cfilter-select option:checked{ background:#2b2f6b; color:#fff; }

  .items{display:grid; gap:8px; margin-top:10px}
  .item{
    display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center;
    padding:8px; border-radius:12px; border:1px dashed rgba(255,255,255,.15); background:rgba(255,255,255,.04);
    position:relative;
  }
  .item.note::before{
    content:""; position:absolute; right:8px; top:8px; width:6px; height:6px; border-radius:999px;
    background: var(--accent-2); box-shadow:0 0 6px rgba(255,0,0,.7)
  }
  .row-left{display:flex; align-items:center; gap:8px}
  .ititle{
    font-weight:800; letter-spacing:.2px; padding:6px 8px; border-radius:8px; background:rgba(255,255,255,.05);
    border:1px solid rgba(255,255,255,.12); min-height:34px; display:flex; align-items:center
  }
  .ititle[contenteditable="true"]{outline:2px solid rgba(0,224,194,.6)}
  .linkbox{display:flex; gap:6px; align-items:center}
  .ipayload{
    min-width:260px; max-width:420px; width:100%; padding:8px 10px; border-radius:8px;
    border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:var(--ink);
    font-size:13px;
  }
  .open{background:linear-gradient(90deg, var(--ok), var(--warn)); color:#0b0d1f}
  .itag{font-size:11px; color:var(--muted)}

  /* Panel flotante (buscador global) */
  .float{
    position:sticky; top:16px; align-self:start;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:14px;
    display:grid; grid-template-rows:auto auto 1fr auto; gap:10px;
  }
  .fhead{font-weight:900; letter-spacing:.3px; margin:0 0 4px}
  .search{display:flex; gap:8px}
  #q{
    flex:1; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14);
    background:rgba(255,255,255,.06); color:var(--ink); font-weight:700; letter-spacing:.2px
  }
  .res{
    max-height:380px; overflow-y:auto; overflow-x:hidden;
    display:grid; gap:6px; width:100%;
  }
  .hit{
    width:100%; padding:8px; border-radius:10px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12);
    cursor:pointer; font-size:13px; overflow-wrap:anywhere;
  }
  .hit b{color:#fff}
  .hit:hover{filter:brightness(1.06)}
  .empty{color:var(--muted); font-size:12px; text-align:center; padding:10px 0}

  /* BOTONERA STICKY ABAJO-DERECHA DEL BUSCADOR */
  .toolbox{
    position:sticky; bottom:0;
    display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;
    padding-top:10px; margin-top:6px;
    background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.65) 30%, rgba(0,0,0,.9));
    border-top:1px solid rgba(255,255,255,.08);
    border-radius:0 0 12px 12px;
  }

  /* Modales (notas y carga masiva comparten estilos) */
  .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); backdrop-filter: blur(2px)}
  .modal.open{display:grid}
  .modal .box{background:var(--card); border:1px solid rgba(255,255,255,.12); border-radius:20px; padding:22px; width:min(680px,100%)}
  .modal h2{margin:0 0 6px}
  .modal p{color:var(--muted)}
  .note-wrap{margin-top:10px}
  .note-wrap label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  #noteArea, #bulkArea{
    width:100%; min-height:180px; resize:vertical;
    background:rgba(255,255,255,.06); color:var(--ink);
    border:1px solid rgba(255,255,255,.14); border-radius:12px; padding:10px 12px;
    font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  }
  .actions{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; justify-content:center}

  /* === P√≠ldoras de estado + men√∫ === */
  .pill{
    height:32px; padding:0 12px; border-radius:999px;
    border:0; font-weight:700; font-size:12px;
    display:inline-flex; align-items:center;
    cursor:pointer; box-shadow: 0 0 0 1px rgba(255,255,255,.08) inset;
    background: rgba(255,255,255,.06); color:#cdd3ff;
  }
  .pill-none{ background:rgba(255,255,255,.06); color:#bfc8d6; }
  .pill-muyb{ background:#22c55e; color:#06240f; }
  .pill-bueno{ background:#3b82f6; color:#fff; }
  .pill-medio{ background:#f59e0b; color:#1b1200; }
  .pill-debil{ background:#6b7280; color:#0b0e12; }

  .row-left > .pill{ flex:1 1 auto; justify-content:center; min-width:120px; }

  .label-menu{
    position:fixed; z-index:9999; list-style:none; margin:0; padding:6px;
    background:rgba(20,22,30,.98); border:1px solid rgba(255,255,255,.08);
    border-radius:12px; box-shadow:0 12px 24px rgba(0,0,0,.35);
  }
  .label-menu li{ padding:4px; }
  .label-menu li .pill{ width:100%; justify-content:center; }

  /* Tooltip de notas */
  #tooltip{
    position:fixed; z-index:10000; display:none; opacity:0;
    max-width:520px; max-height:260px; overflow:auto;
    padding:10px 12px; border-radius:12px;
    background:linear-gradient(180deg, rgba(30,32,50,.98), rgba(22,24,40,.98));
    border:1px solid rgba(255,255,255,.12); color:var(--ink);
    box-shadow:0 12px 28px rgba(0,0,0,.45);
    transition:opacity .08s ease;
  }
  #tooltip.show{ display:block; opacity:1; }
  .tt-title{ font-weight:800; margin-bottom:6px }
  .tt-body{ white-space:pre-wrap; line-height:1.35 }
  .tt-meta{ margin-top:8px; font-size:11px; color:var(--muted) }

  .pulse{ outline:2px solid #7c5cff; transition: outline .8s; }
</style>
</head>
<body>
  <main class="app">
    <section class="card">
      <h1>Repositorio de Payloads</h1>
      <p class="sub">Organiz√° tus payloads por <b>categor√≠a</b> (XSS, IDOR, RCE, ‚Ä¶). Todo persiste en <b>localStorage</b>. Filtros por estado y texto, notas con tooltip, copiar por rengl√≥n o toda la categor√≠a.</p>

      <div id="cats"></div>
    </section>

    <!-- Panel flotante -->
    <aside class="float">
      <h3 class="fhead">Buscar payloads</h3>
      <div class="search">
        <input id="q" type="text" placeholder="Ej: <img, onerror, fetch, dom‚Ä¶" />
        <button id="clearQ" class="btn ghost">Limpiar</button>
      </div>
      <div id="results" class="res"><div class="empty">Empieza a tipear para filtrar‚Ä¶</div></div>
      <div class="itag">Sugerencia: Enter salta al primer resultado.</div>

      <!-- Botonera fija abajo-derecha del buscador -->
      <div class="toolbox">
        <button id="addCat" class="btn">+ Agregar categor√≠a</button>
        <button id="export" class="btn ghost" title="Copia un JSON con tu base">Exportar JSON</button>
        <button id="import" class="btn ghost" title="Pega un JSON para restaurar">Importar JSON</button>
        <button id="wipe" class="btn ghost" title="Borrar todo (peligroso)">Borrar todo</button>
      </div>
    </aside>
  </main>

  <!-- Modal de notas -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mod-title">
    <div class="box">
      <center><h2 id="mod-title"> Nota</h2></center>
      <center><p id="mod-msg">Detalles, variantes, bypasses, referencias‚Ä¶</p></center>
      <div class="note-wrap">
        <label id="noteLabel" for="noteArea">Nota</label>
        <textarea id="noteArea" placeholder="Tips, cadenas, CSP, contextos, mutaciones‚Ä¶"></textarea>
        <p id="metaInfo" style="font-size:12px;color:var(--muted);margin:6px 0 0"></p>
      </div>
      <div class="actions">
        <button id="saveNote" class="btn">Guardar (Ctrl+S)</button>
        <button id="clearNote" class="btn ghost">Borrar nota</button>
        <button id="close" class="btn ghost">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de CARGA MASIVA -->
  <div id="bulkModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="bulk-title">
    <div class="box">
      <center><h2 id="bulk-title">Carga masiva de payloads</h2></center>
      <center><p class="sub" style="margin:0 0 10px">Peg√° <b>uno por l√≠nea</b>. Se crear√°n renglones autom√°ticos.</p></center>
      <div class="note-wrap">
        <label for="bulkArea">Lista de payloads</label>
        <textarea id="bulkArea" placeholder="Ejemplo:
<img src=x onerror=alert(1)>
</script><svg onload=confirm(1)>
' OR 1=1 --"></textarea>
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px; color:var(--muted); font-size:12px">
          <label><input id="bulkUseSnippet" type="checkbox" checked> Usar inicio del payload como t√≠tulo</label>
          <label><input id="bulkTrimEmpty" type="checkbox" checked> Ignorar l√≠neas vac√≠as</label>
        </div>
      </div>
      <div class="actions">
        <button id="bulkCreate" class="btn">Crear renglones (Ctrl+Enter)</button>
        <button id="bulkCancel" class="btn ghost">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Tooltip -->
  <div id="tooltip" role="tooltip" aria-hidden="true"></div>

<script>
(function(){
  // ====== Storage ======
  const KEY = 'aquiles_payloads_data_v1';
  const UIKEY = 'aquiles_payloads_ui_filters_v1';
  const catsEl = document.getElementById('cats');

  function uid(){ return Math.random().toString(36).slice(2,9); }
  function load(){
    try{ const o = JSON.parse(localStorage.getItem(KEY)||''); if(o && Array.isArray(o.cats)) return o; }catch{}
    return {
      cats: [
        { id: uid(), title: 'XSS',  items: [] },
        { id: uid(), title: 'IDOR', items: [] },
        { id: uid(), title: 'RCE',  items: [] },
      ]
    };
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }
  let state = load();

  // ====== filtros UI por categor√≠a (persistentes) ======
  let filters = loadFilters();
  function loadFilters(){ try{ return JSON.parse(localStorage.getItem(UIKEY)||'{}'); }catch{ return {}; } }
  function getFilter(catId){ return filters[catId] || { text:'', state:'all' }; }
  function setFilter(catId, patch){
    filters[catId] = { ...getFilter(catId), ...patch };
    localStorage.setItem(UIKEY, JSON.stringify(filters));
    render();
  }

  // ====== Estados (payload quality) ======
  const STATUS_SET = [
    { id:'muyb',   text:'Muy bueno', cls:'pill-muyb'  },
    { id:'bueno',  text:'Bueno',     cls:'pill-bueno' },
    { id:'medio',  text:'Medio',     cls:'pill-medio' },
    { id:'debil',  text:'D√©bil',     cls:'pill-debil' }
  ];
  function statusObj(id){ return STATUS_SET.find(s=>s.id===id)||null; }

  // ====== Tooltip helpers ======
  const $tt = document.getElementById('tooltip');
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function tipHtml(item){
    const title = escapeHtml(item.title || 'Payload');
    const body  = (item.note||'').trim() ? escapeHtml(item.note).replace(/\n/g,'\n') : '<i>Sin nota</i>';
    const meta  = item.editedTs ? `<div class="tt-meta">√öltima edici√≥n: ${new Date(item.editedTs).toLocaleString()}</div>` : '';
    return `<div class="tt-title">${title}</div><div class="tt-body">${body}</div>${meta}`;
  }
  function showTip(html, x, y){ $tt.innerHTML = html; $tt.classList.add('show'); positionTip(x,y); $tt.setAttribute('aria-hidden','false'); }
  function moveTip(x, y){ if($tt.classList.contains('show')) positionTip(x,y); }
  function hideTip(){ $tt.classList.remove('show'); $tt.setAttribute('aria-hidden','true'); }
  function positionTip(x, y){
    const pad=10, off=16, mw=$tt.offsetWidth, mh=$tt.offsetHeight;
    let left=x+off, top=y+off;
    if(left+mw>innerWidth-pad) left=x-mw-off; if(left<pad) left=pad;
    if(top+mh>innerHeight-pad) top=y-mh-off;  if(top<pad) top=pad;
    $tt.style.left=left+'px'; $tt.style.top=top+'px';
  }
  function bindNoteTooltip(el, item){
    el.addEventListener('mouseenter', e=> showTip(tipHtml(item), e.clientX, e.clientY));
    el.addEventListener('mousemove',  e=> moveTip(e.clientX, e.clientY));
    el.addEventListener('mouseleave', hideTip);
  }

  // ====== Render ======
  function render(){
    catsEl.innerHTML = '';
    state.cats.forEach(cat=>{
      const wrap = document.createElement('section');
      wrap.className = 'category'; wrap.dataset.id = cat.id;

      // header
      const head = document.createElement('div'); head.className = 'chead';

      const title = document.createElement('h2');
      title.className = 'ctitle';
      title.textContent = cat.title + ' (' + (cat.items?.length||0) + ')';
      title.title = 'Doble click para editar';
      title.addEventListener('dblclick', ()=> editCatTitle(title, cat));

      // filtros
      const fwrap = document.createElement('div'); fwrap.className='cfilters';
      const fState = document.createElement('select'); fState.className='cfilter-select';
      fState.innerHTML = `
        <option value="all">Estado: todos</option>
        <option value="none">Sin etiqueta</option>
        ${STATUS_SET.map(s=>`<option value="${s.id}">${s.text}</option>`).join('')}
      `;
      const curF = getFilter(cat.id);
      fState.value = curF.state;
      fState.addEventListener('change', ()=> setFilter(cat.id, {state:fState.value}));

      const fText = document.createElement('input'); fText.className='cfilter-input'; fText.placeholder='Filtrar por texto‚Ä¶';
      fText.value = curF.text;
      fText.addEventListener('input', ()=> setFilter(cat.id, {text:fText.value.trim().toLowerCase()}));

      fwrap.append(fState, fText);

      // acciones
      const actions = document.createElement('div'); actions.className = 'cactions';
      const addItemBtn = btn('+ Agregar rengl√≥n', ()=> addItem(cat.id));
      const bulkBtn    = btn('Carga masiva', ()=> openBulk(cat.id), false);
      const copyAllBtn = btn('Copiar TODOS los payloads', ()=> copyAll(cat.id), false);
      copyAllBtn.title = 'Respeta el filtro activo';
      const delCatBtn  = btn('Eliminar categor√≠a', ()=> delCat(cat.id), true);
      actions.append(addItemBtn, bulkBtn, copyAllBtn, delCatBtn);

      head.append(title, fwrap, actions);
      wrap.appendChild(head);

      // items (filtrados)
      const list = document.createElement('div'); list.className = 'items';
      const flt = getFilter(cat.id);
      const visible = (cat.items||[]).filter(it=>matchItem(it, flt));

      visible.forEach(item=>{
        const row = document.createElement('div'); row.className = 'item'; row.dataset.item = item.id;
        if((item.note||'').trim()) row.classList.add('note');

        // izquierda: t√≠tulo + estado
        const left = document.createElement('div'); left.className = 'row-left';

        const ititle = document.createElement('div'); ititle.className = 'ititle'; ititle.textContent = item.title || 'Nuevo payload';
        ititle.title = 'Doble click para editar el t√≠tulo';
        ititle.addEventListener('dblclick', ()=> editItemTitle(ititle, cat.id, item.id));

        const pill = renderStatusPill(cat.id, item.id);
        left.append(ititle, pill);

        // centro: PAYLOAD + copiar
        const linkB = document.createElement('div'); linkB.className = 'linkbox';
        const ipayload = document.createElement('input'); ipayload.className='ipayload'; ipayload.type='text'; ipayload.placeholder='<img src=x onerror=alert(1)>';
        ipayload.value = item.payload || '';
        ipayload.addEventListener('change', ()=>{ item.payload = ipayload.value; save(); buildIndex(); });
        const copyBtn = document.createElement('button'); copyBtn.className='btn open'; copyBtn.textContent='Copiar';
        copyBtn.title = 'Copiar payload al portapapeles';
        copyBtn.addEventListener('click', ()=>{
          const v = (item.payload||'').trim();
          if(!v){ alert('Este rengl√≥n no tiene payload.'); return; }
          navigator.clipboard.writeText(v).then(()=>{ copyBtn.blur(); }).catch(()=> alert('No pude copiar.'));
        });
        linkB.append(ipayload, copyBtn);

        // derecha: herramientas
        const tools = document.createElement('div'); tools.style.display='flex'; tools.style.gap='6px';
        const noteBtn = btn('Nota', ()=> openNote(cat.id, item.id), false);
        const delBtn  = btn('Borrar', ()=> delItem(cat.id, item.id), true);
        tools.append(noteBtn, delBtn);

        row.append(left, linkB, tools);

        // tooltips de nota
        bindNoteTooltip(row, item);
        bindNoteTooltip(noteBtn, item);

        // click en cuerpo abre nota
        row.addEventListener('click', (e)=>{
          const t = e.target.tagName.toLowerCase();
          if(t==='input' || t==='button' || t==='a' || e.target.classList.contains('pill')) return;
          openNote(cat.id, item.id);
        });

        list.appendChild(row);
      });

      wrap.appendChild(list);
      catsEl.appendChild(wrap);
    });

    buildIndex(); // refrescar √≠ndice de b√∫squeda global
  }

  function matchItem(item, flt){
    const textOk = !flt.text || (`${item.title} ${item.payload||''} ${item.note||''}`.toLowerCase().includes(flt.text));
    const stateOk =
      flt.state==='all'  ? true :
      flt.state==='none' ? !item.status :
      item.status===flt.state;
    return textOk && stateOk;
  }

  function btn(txt, fn, ghost=false){
    const b = document.createElement('button');
    b.className = 'btn' + (ghost?' ghost':''); b.textContent = txt; b.addEventListener('click', fn);
    return b;
  }

  // ====== P√≠ldora de estado ======
  function renderStatusPill(catId, itemId){
    const { item } = getCI(catId, itemId);
    const s = statusObj(item.status);
    const btn = document.createElement('button');
    btn.className = 'pill ' + (s ? s.cls : 'pill-none');
    btn.textContent = s ? s.text : 'Estado';
    btn.title = 'Click = etiquetar ‚Ä¢ Alt/Click medio = alternar';

    btn.addEventListener('click', (e)=>{
      if (e.altKey) { cycleStatus(catId, itemId); return; }
      openStatusMenu(btn, catId, itemId);
    });
    btn.addEventListener('auxclick', (e)=>{
      if(e.button===1){ e.preventDefault(); cycleStatus(catId, itemId); }
    });
    return btn;
  }

  function openStatusMenu(anchor, catId, itemId){
    closeMenus();
    const menu = document.createElement('ul');
    menu.className = 'label-menu';
    const add = (id, text, cls)=>{
      const li = document.createElement('li');
      li.innerHTML = `<span class="pill ${cls}">${text}</span>`;
      li.onclick = ()=>{ setStatus(catId, itemId, id); closeMenus(); };
      menu.appendChild(li);
    };
    add(null,'Sin etiqueta','pill-none');
    STATUS_SET.forEach(s=> add(s.id, s.text, s.cls));
    document.body.appendChild(menu);

    requestAnimationFrame(()=>{
      const r = anchor.getBoundingClientRect();
      const pad=8, mw=menu.offsetWidth, mh=menu.offsetHeight;
      let left=r.left, top=r.bottom+6;
      if(left+mw>innerWidth-pad) left=innerWidth-pad-mw;
      if(left<pad) left=pad;
      if(top+mh>innerHeight-pad) top=r.top-6-mh;
      if(top<pad) top=pad;
      menu.style.left=`${left}px`; menu.style.top=`${top}px`;
    });

    const outside = ev=>{ if(!menu.contains(ev.target) && ev.target!==anchor) closeMenus(); };
    const onEsc = ev=>{ if(ev.key==='Escape') closeMenus(); };
    setTimeout(()=> document.addEventListener('mousedown', outside, { once:true }));
    document.addEventListener('keydown', onEsc, { once:true });
  }
  function closeMenus(){ document.querySelectorAll('.label-menu').forEach(m=>m.remove()); }
  function setStatus(catId, itemId, status){
    const { item } = getCI(catId, itemId); if(!item) return;
    item.status = status || null; save(); render();
  }
  function cycleStatus(catId, itemId){
    const { item } = getCI(catId, itemId); if(!item) return;
    const ids = [null, ...STATUS_SET.map(s=>s.id)];
    const next = ids[(ids.indexOf(item.status||null)+1)%ids.length];
    setStatus(catId, itemId, next);
  }

  // ====== Ediciones ======
  function editCatTitle(el, cat){
    el.setAttribute('contenteditable','true'); el.focus();
    selectAll(el);
    const end = ()=>{ el.removeAttribute('contenteditable'); };
    el.addEventListener('keydown', onKey);
    el.addEventListener('blur', onBlur);
    function onKey(e){
      if(e.key==='Enter'){ e.preventDefault(); el.blur(); }
      else if(e.key==='Escape'){ e.preventDefault(); el.textContent = cat.title + ' ('+(cat.items?.length||0)+')'; el.blur(); }
    }
    function onBlur(){
      el.removeEventListener('keydown', onKey); el.removeEventListener('blur', onBlur); end();
      const v = el.textContent.replace(/\(\d+\)\s*$/,'').trim() || 'Sin nombre';
      cat.title = v; save(); render();
    }
  }
  function editItemTitle(el, catId, itemId){
    const { item } = getCI(catId, itemId); if(!item) return;
    el.setAttribute('contenteditable','true'); el.focus(); selectAll(el);
    const end = ()=>{ el.removeAttribute('contenteditable'); };
    el.addEventListener('keydown', onKey);
    el.addEventListener('blur', onBlur);
    function onKey(e){
      if(e.key==='Enter'){ e.preventDefault(); el.blur(); }
      else if(e.key==='Escape'){ e.preventDefault(); el.textContent = item.title||'Nuevo payload'; el.blur(); }
    }
    function onBlur(){
      el.removeEventListener('keydown', onKey); el.removeEventListener('blur', onBlur); end();
      item.title = (el.textContent||'').trim() || 'Nuevo payload'; save(); render();
    }
  }
  function selectAll(el){
    const r = document.createRange(); r.selectNodeContents(el);
    const s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
  }

  // ====== CRUD ======
  function addCategory(){
    const name = prompt('Nombre de la categor√≠a:', 'Nueva categor√≠a');
    if(name===null) return;
    state.cats.push({ id:uid(), title: (name||'Nueva categor√≠a').trim() || 'Nueva categor√≠a', items:[] });
    save(); render();
  }
  function delCat(catId){
    if(!confirm('¬øEliminar la categor√≠a completa?')) return;
    state.cats = state.cats.filter(c=>c.id!==catId);
    save(); render();
  }
  function addItem(catId){
    const cat = state.cats.find(c=>c.id===catId); if(!cat) return;
    cat.items.push({ id:uid(), title:'Nuevo payload', payload:'', note:'', editedTs:0, status:null });
    save(); render();
  }
  function delItem(catId, itemId){
    const cat = state.cats.find(c=>c.id===catId); if(!cat) return;
    cat.items = cat.items.filter(i=>i.id!==itemId);
    save(); render();
  }

  document.getElementById('addCat').addEventListener('click', addCategory);

  // ====== Notas (modal) ======
  const $modal = document.getElementById('modal');
  const $noteArea = document.getElementById('noteArea');
  const $metaInfo = document.getElementById('metaInfo');
  const $saveNote = document.getElementById('saveNote');
  const $clearNote = document.getElementById('clearNote');
  const $close = document.getElementById('close');
  const $noteLabel = document.getElementById('noteLabel');
  const $modTitle = document.getElementById('mod-title');

  let active = { catId:null, itemId:null };

  function openNote(catId, itemId){
    const {cat, item} = getCI(catId, itemId); if(!item) return;
    active = {catId, itemId};
    $modTitle.textContent = 'üìù ' + (item.title || 'Payload');
    $noteLabel.textContent = 'Nota ‚Äî ' + (item.title || 'Payload');
    $noteArea.value = item.note || '';
    $metaInfo.textContent = item.editedTs ? ('√öltima edici√≥n: ' + new Date(item.editedTs).toLocaleString()) : '‚Äî';
    $modal.classList.add('open');
    hideTip();
  }
  function closeNote(){ $modal.classList.remove('open'); }

  // ====== Carga masiva ======
  const $bulkModal = document.getElementById('bulkModal');
  const $bulkArea = document.getElementById('bulkArea');
  const $bulkUseSnippet = document.getElementById('bulkUseSnippet');
  const $bulkTrimEmpty = document.getElementById('bulkTrimEmpty');
  const $bulkCreate = document.getElementById('bulkCreate');
  const $bulkCancel = document.getElementById('bulkCancel');
  let bulkTargetCatId = null;

  function openBulk(catId){
    bulkTargetCatId = catId;
    $bulkArea.value = '';
    $bulkModal.classList.add('open');
    setTimeout(()=> $bulkArea.focus(), 0);
  }
  function closeBulk(){
    $bulkModal.classList.remove('open');
    bulkTargetCatId = null;
  }
  $bulkCancel.addEventListener('click', closeBulk);
  $bulkCreate.addEventListener('click', doBulkCreate);
  window.addEventListener('keydown', (e)=>{
    if($bulkModal.classList.contains('open') && e.ctrlKey && e.key.toLowerCase()==='enter'){
      e.preventDefault(); doBulkCreate();
    }
  });

  function doBulkCreate(){
    const cat = state.cats.find(c=>c.id===bulkTargetCatId);
    if(!cat){ closeBulk(); return; }
    let lines = $bulkArea.value.replace(/\r/g,'\n').split('\n');
    if($bulkTrimEmpty.checked){ lines = lines.map(l=>l.trim()).filter(l=>l.length>0); }
    if(!lines.length){ alert('No hay l√≠neas para importar.'); return; }

    const MAX_CREATE = 5000; // safety ‚Äî no nos vamos a DDoSear el DOM
    const toCreate = lines.slice(0, MAX_CREATE);

    toCreate.forEach((payload, idx)=>{
      const title = $bulkUseSnippet.checked
        ? (payload.replace(/\s+/g,' ').slice(0, 48) || `Payload ${idx+1}`)
        : `Payload ${idx+1}`;
      cat.items.push({
        id: uid(),
        title: title,
        payload: payload,
        note: '',
        editedTs: 0,
        status: null
      });
    });

    save();
    closeBulk();
    render();
    alert(`Creados ${toCreate.length} renglones en "${cat.title}".`);
  }

  // ====== Export/Import/Wipe ======
  document.getElementById('export').addEventListener('click', ()=>{
    const json = JSON.stringify(state, null, 2);
    navigator.clipboard.writeText(json).then(()=> alert('JSON copiado al portapapeles ‚úîÔ∏è'));
  });
  document.getElementById('import').addEventListener('click', ()=>{
    const json = prompt('Peg√° el JSON a importar:');
    if(!json) return;
    try{
      const obj = JSON.parse(json);
      if(!obj || !Array.isArray(obj.cats)) throw new Error('Formato inv√°lido');
      obj.cats.forEach(c => (c.items||[]).forEach(i => i.status ??= null));
      state = obj; save(); render();
      alert('Importado ‚úîÔ∏è');
    }catch(e){ alert('No se pudo importar: ' + e.message); }
  });
  document.getElementById('wipe').addEventListener('click', ()=>{
    if(!confirm('Esto borrar√° TODO el repositorio. ¬øSeguro?')) return;
    localStorage.removeItem(KEY);
    state = load(); render();
  });

  // ====== Copiar TODOS (respeta filtro) ======
  function copyAll(catId){
    const cat = state.cats.find(c=>c.id===catId); if(!cat) return;
    const flt = getFilter(catId);
    const vals = (cat.items||[])
      .filter(i=>matchItem(i, flt))
      .map(i => (i.payload||'').trim())
      .filter(u => u.length>0);
    const uniq = [...new Set(vals)];
    if(!uniq.length){ alert('No hay payloads (seg√∫n el filtro actual).'); return; }
    navigator.clipboard.writeText(uniq.join('\n'))
      .then(()=> alert(`Copiados ${uniq.length} payloads √∫nicos de "${cat.title}" (filtro aplicado).`))
      .catch(()=> alert('No pude copiar al portapapeles'));
  }

  // ====== Buscador global ======
  const $q = document.getElementById('q');
  const $clearQ = document.getElementById('clearQ');
  const $results = document.getElementById('results');
  let index = [];
  function buildIndex(){
    index = [];
    state.cats.forEach(c=>{
      c.items.forEach(i=>{
        const el = document.querySelector(`.category[data-id="${c.id}"] [data-item="${i.id}"]`);
        const s = statusObj(i.status)?.text || '';
        index.push({
          txt: `${c.title} ${i.title} ${i.payload||''} ${s} ${(i.note||'')}`.toLowerCase(),
          catTitle: c.title, itemTitle: i.title, itemPayload: i.payload||'',
          catId: c.id, itemId: i.id, el
        });
      });
    });
    runSearch();
  }
  function runSearch(){
    const q = ($q.value||'').trim().toLowerCase();
    $results.innerHTML = '';
    if(!q){
      $results.innerHTML = '<div class="empty">Empieza a tipear para filtrar‚Ä¶</div>';
      return;
    }
    const hits = index.filter(x=> x.txt.includes(q)).slice(0,100);
    if(!hits.length){ $results.innerHTML = '<div class="empty">Sin coincidencias</div>'; return; }
    hits.forEach(h=>{
      const div = document.createElement('div'); div.className='hit';
      const snip = h.itemPayload ? ' ¬∑ ' + escapeHtml(h.itemPayload).slice(0,120) : '';
      div.innerHTML = `<b>${escapeHtml(h.itemTitle||'Sin t√≠tulo')}</b><br><span class="itag">${escapeHtml(h.catTitle)}${snip}</span>`;
      div.addEventListener('click', ()=>{
        h.el?.scrollIntoView({behavior:'smooth', block:'center'});
        h.el?.classList.add('pulse');
        setTimeout(()=> h.el?.classList.remove('pulse'), 800);
      });
      $results.appendChild(div);
    });
  }
  $q.addEventListener('input', runSearch);
  $q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ $results.querySelector('.hit')?.click(); } });
  $clearQ.addEventListener('click', ()=>{ $q.value=''; runSearch(); $q.focus(); });

  // ====== helpers ======
  function getCI(catId, itemId){
    const cat = state.cats.find(c=>c.id===catId);
    const item = cat ? cat.items.find(i=>i.id===itemId) : null;
    return {cat, item};
  }

  // ====== Init ======
  render();

})();
</script>
</body>
</html>
